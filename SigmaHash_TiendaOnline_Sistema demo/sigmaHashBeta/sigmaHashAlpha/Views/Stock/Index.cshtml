@using sigmaHashAlpha.Models.Products
@{
	Layout = "_Layout2";
}

@model ListAndFilter

@{
	var test = (bool)(ViewBag.Filtered??false);
	var filter = (string)(ViewBag.FilterText);
}

<input id="filtered" value="@Model.Filtered" hidden/>
<input id="filtertext" value="@Model.FilterText" hidden/>
	
<div class="GeneralContainer StockContainer">
	<div class="ProductListHeader" style="position: relative;">
	    <div class="webtitle"><a asp-controller="Stock" asp-action="Index">Stock Manager</a></div>
		
		<div class = 'toggle-switch'>
            <label class="switchlabel">
                <input type = 'checkbox'>
                <span class = 'DLslider'></span>
            </label>

        </div>

	</div> 
	

	<div class="ListAndFilter">

		<div class="filtercontainer">
			<div class="filter ">

				<div class="filtercategories centerer"  id="opencloser"> <div>Categories</div> <div class="filterarrow"><i id="filterarrow" class="bi bi-chevron-down"></i></div> </div>
				<div class="catlist centerer">
					@using(Html.BeginForm("SideBarSearch","Stock", FormMethod.Post)){
						<div class="catlistchild">
							<div class="cattitle" style="position:relative">Motherboards  <span><i class="bi bi-chevron-down"></i></span> </div>
							<div class="subcat"><button class="subcat" value="Intel">- Chipset Intel</button></div>
							<div class="subcat"><button class="subcat" value="AMD">- Chipset AMD</button></div>
						</div>
					
					
						<div class="catlistchild">
							<div class="cattitle" style="position:relative">Graphic Cards<span><i class="bi bi-chevron-down"></i></span> </div>
							<div class="subcat"><button type="submit" name="filter" value="Radeon" class="subcat">- Placas Radeon</button></div>
							<div class="subcat"><button type="submit" name="filter" value="GeForce" class="subcat">- Placas Geforce</button></div>
						</div>
					
					
						<div class="catlistchild">
							<div class="cattitle" style="position:relative">Procesadores<span><i class="bi bi-chevron-down"></i></span> </div>
							<div class="subcat"><button type="submit" name="filter" value="AMD" class="subcat">- Procesadores AMD</button></div>
							<div class="subcat"><button type="submit" name="filter" value="Intel" class="subcat">- Procesadores Intel</button></div>
						</div>
					
			
						<div class="catlistchild">
							<div class="cattitle" style="position:relative">Memorias RAM<span><i class="bi bi-chevron-down"></i></span> </div>
							<div class="subcat"><button type="submit" name="filter" value="DDR3" class="subcat">- DDR3</button></div>
							<div class="subcat"><button type="submit" name="filter" value="DDR4" class="subcat">- DDR4</button></div>
							<div class="subcat"><button type="submit" name="filter" value="DDR5" class="subcat">- DDR5</button></div>
						</div>
					
					
						<div class="catlistchild">
							<div class="cattitle" style="position:relative">Alamacenamiento<span><i class="bi bi-chevron-down"></i></span> </div>
							<div class="subcat"><button type="submit" name="filter" value="HDD" class="subcat">- Disco rigido</button></div>
							<div class="subcat"><button type="submit" name="filter" value="SSD" class="subcat">- Disco solido</button></div>
							<div class="subcat"><button type="submit" name="filter" value="M.2" class="subcat">- NVME</button></div>
						</div>
						<div class="catlistchild">
							<div class="cattitle" style="position:relative">Teclados y mouses<span><i class="bi bi-chevron-down"></i></span> </div>
							<div class="subcat"><button type="submit" name="filter" value="Keyboard" class="subcat">- Teclados</button></div>
							<div class="subcat"><button type="submit" name="filter" value="Mouse" class="subcat">- Mouses</button></div>
@*							<div class="subcat"><button type="submit" name="filter" value="DDR4" class="subcat">- Mouse pads</button></div>*@
						</div>
						<div class="catlistchild">
							<div class="cattitle" style="position:relative">Gabinetes, fuentes, coolers<span><i class="bi bi-chevron-down"></i></span> </div>
							<div class="subcat"><button type="submit" name="filter" value="Case" class="subcat">- Gabinetes</button></div>
							<div class="subcat"><button type="submit" name="filter" value="PSU" class="subcat">- Fuentes</button></div>
							<div class="subcat"><button type="submit" name="filter" value="Cooler" class="subcat">- Cooler fans/Water cooling</button></div>
						</div>
					
						<div class="catlistchild">
							<div class="cattitle" style="position:relative">Accesorios<span><i class="bi bi-chevron-down"></i></span> </div>
							<div class="subcat"><button type="submit" name="filter" value="Mousepad" class="subcat">- Mouse Pads</button></div>
							<div class="subcat"><button type="submit" name="filter" value="Audio" class="subcat">- Headsets/Audio</button></div>
							<div class="subcat"><button type="submit" name="filter" value="Joystick" class="subcat">- Gamepads/Controllers/Joysticks</button></div>
							<div class="subcat"><button type="submit" name="filter" value="Chair" class="subcat">- Sillas</button></div>
						</div>

						<div style="height: 50px;">

						</div>
					}
				</div>	
			</div>
		</div>			
		
		<div class="StockList">
			<div class="searchbarcontainer centerer">
				<div class="searchbar">

					
					
					@using(Html.BeginForm("SearchBar","Stock", FormMethod.Post))
					{
					
						<input asp-for="Filter.Page" value="1" hidden/>
						if(Model.Filtered == true)
						{
							<input type="text" asp-for="Filter" id="searchbox" class="searchbox" value="@ViewBag.Filter" placeholder="@ViewBag.Filter" />
						}
						else
						{
							<input type="text" asp-for="Filter"  id="searchbox" class="searchbox" placeholder="Search for an item" />
						}
						<button class="searchbtn" type="submit"><div class="searchmagn centerer"><i class="bi bi-search"></i></div></button>
					}

				</div>

			</div>

			<div class="stocktable">
				
				<table class="table">
					<tr>
						@using(Html.BeginForm("Criteria","Stock", FormMethod.Post))
						{
							<th style="width: 8%;">
								<a asp-action="CriteriaCategory" asp-controller="Stock">Category</a>
								
								
									<span style="font-size: 1.3rem; margin-left: 5px;"><i class="bi bi-sort-down-alt"></i></span>
							

							</th>
							<th>
								Id
							</th>
							<th>
								<a asp-action="CriteriaBrand" asp-controller="Stock">Brand</a><span style="font-size: 1.3rem; margin-left: 5px;"><i class="bi bi-sort-down-alt"></i></span>
							</th>
							<th>
								Model
							</th>
							<th class="stock">
								
								@if(TempData["criteria"] == "stockdec" || TempData["criteria"] == null )
								{
									<a asp-action="CriteriaStockUp" asp-controller="Stock">Stock</a>
									<span style="font-size: 1.3rem; margin-left: 5px;"><i class="bi bi-sort-down-alt"></i></span>
								}
								@if(TempData["criteria"] == "stockasc")
								{
									<a asp-action="CriteriaStockDown" asp-controller="Stock">Stock</a>
									<span style="font-size: 1.3rem; margin-left: 5px;"><i class="bi bi-sort-up-alt"></i></span>
								}


							</th>
						}

					</tr>
					@{var c = 1;}
					@{string Class="";}
					@foreach(var obj in Model.List)
					{
						@if(c % 2 == 0)
						{
							Class = "tdcolor1";
						}
						else
						{
							Class = "tdcolor2";
						}
						<tr class="@Class">
							<td>
								<div>
									@obj.Category
								</div>
								
							</td>
							<td class="rowid">
								@obj.Id
							</td>
							<td>
								@obj.Brand
							</td>
							<td>
								@obj.Model
							</td>
							<td class="stockfield">
								@obj.Stock
							</td>
							<td class="stockbtns">
								<input type="hidden" class="hiddenstock" value="@obj.Stock"/>
								<input type="hidden" class="hiddenid" value="@obj.Id"/>
								<input class="addinput" type="number" min="0" /><button class="btn btn-primary addbtn">+</button>
								<input class="subinput" type="number" min="0" /><button class="btn btn-danger subbtn">-</button>

							</td>



						</tr>

						c++;
					}
			
			
				</table>

			
			</div>
			
			
			
			
			<div class="pagenumbcont">
				@{
					int? pages = Model.PageCount;


					for (int i = 1; i <= pages; i++)
					{
																																																																			@using (Html.BeginForm("Pages", "Products", FormMethod.Post))
						{
																																																																				<input asp-for="Page" value="@i" hidden/>
																																																																				<input asp-for="Filter" value="@Model.Filter" hidden />
																																																																				<button type="submit" class="pagenumb"> @i </button>
						}
					}
				}
			</div>
		</div>
	</div>
</div>


@section Scripts
{
	

	<script src="~/js/ProductList.js" asp-append-version="true"></script>
	<script type="text/javascript">

		$(document).ready(function () {
           
            let margincount = 0;
		
            $('#opencloser').click(function() {

                if (margincount === 0) {
					$('.stocktable').css('transform', 'translateX(0)');
                    margincount = 1;
				}
					
                else {
                    $('.stocktable').css('transform', 'translateX(-200px)');
                    margincount = 0;
				}
            });

            $('.addbtn').each(function() {

                this.addEventListener('click', function(event) {

                    

                    let temp = this;
                    event.stopPropagation();
                    event.preventDefault();
                    let id = $(this).parent().find('.hiddenid').val();
                    let amount = $(this).parent().find('.addinput').val();
                    let stock = $(this).parent().find('.hiddenstock').val();

                    if (amount != null && amount != 0 && amount != NaN) {
                        $.ajax({
                            type: "POST",
                            url: "@(Url.Action("ChangeStock","Stock"))",
                            data: { id: id, amount: amount }

                        }).done(function() {

                            let num = parseInt(amount) + parseInt(stock);
                            $(temp).parent().parent().find('.stockfield').text(num.toString());
                            $(temp).parent().find('.addinput').val("");
							$(temp).parent().find('.hiddenstock').val(num);
							toastr.success('Stock has been modified succesfuly', 'Stock');
                        });
                    }

                });

            });

				$('.subbtn').each(function() {

					this.addEventListener('click', function(event) {
                     
					    let temp = this;
					    event.stopPropagation();
					    event.preventDefault();
					    let id = $(this).parent().find('.hiddenid').val();
					    let value = $(this).parent().find('.subinput').val();
						
                        let amount = parseInt(value);
                        amount = amount * -1;
					    let stock = $(this).parent().find('.hiddenstock').val();
			

					    if (!isNaN(amount)) {
					        $.ajax({
					            type: "POST",
					            url: "@(Url.Action("ChangeStock","Stock"))",
					            data: { id: id, amount: amount }

					        }).done(function(result) {

					            let num = parseInt(amount) + parseInt(stock);
                                if (num < 0) {num = 0 }
					            $(temp).parent().parent().find('.stockfield').text(num.toString());
					            $(temp).parent().find('.subinput').val("");
								$(temp).parent().find('.hiddenstock').val(num);
                                toastr.success('Stock has been modified succesfuly', 'Stock');
					        });
					    }

					});

				});



            if ($('#filtered').val() === true) {
                $('.searchbox').value += $('#filtertext').val();
			}

			searchbox = document.getElementById('searchbox');
			var search;
			searchbox.onkeyup = function () {
			    search = searchbox.value;
			}

            $('.pagenumb').each(function() 
			{	
                this.addEventListener('click', function() {
                    let temp = this.val();
                    if ($('#filtered').val() === true) {
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        let obj = {
                            Filter: search,
                            Page: temp
                        };
                        $.ajax({
                            type: "POST",
							url: "@(Url.Action("Search","Products"))",
                            data: { obj },
							contentType: "application/json; charset=utf-8",
                            success: function() {
                                alert('succ');
                            },
                            error: function() {
                                alert('err');
                            }
                        }).done(function() {
                            alert('done');
                        });
                    }

                });

            });

		});	
	</script>
}